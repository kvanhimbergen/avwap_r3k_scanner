# Backtest Trust Guide (Operator-Facing)

This system is designed to be **deterministic, offline-only, and auditable**. If anything that would invalidate a result is detected, the system fails loudly before producing misleading outputs.

## What is enforced (invariants)

The following invariants are enforced by code and tests:

- **Determinism**: identical inputs produce identical outputs (aside from allowed metadata). Runs are repeatable by design.
- **No lookahead**: signals and fills do not use future data.
- **Offline-only**: backtests run strictly against local OHLCV data; network calls are blocked by configuration and validated in tests.
- **Parity enforcement**: scan candidates generated by `scan_engine` and `backtest_engine` must match exactly (schema + values).
- **Guardrails**: hard limits for risk per trade, gross exposure, concurrent positions, entries per day, and symbols per day are enforced with hard failures.
- **Provenance**: every run must include stable provenance fields (run_id, git SHA, config hash, data hash, data path, execution mode, parameters used). Missing or inconsistent provenance fails the run.

## Deterministic does **not** mean

Deterministic means: *given the same inputs, the logic produces the same results.*

It does **not** mean:

- **Identical wall-clock timestamps**: timestamps may differ because they reflect when the run was executed.
- **Identical output paths**: output directories can differ if you choose a different root or run directory.
- **Bitwise identical files across OSes**: Mac vs Linux may differ cosmetically (e.g., file ordering, JSON formatting, or platform metadata), but **the logic and computed fields are identical**.

## Why timestamps may differ

Some metadata (e.g., `timestamp_utc`) records *when* a run happened. This is expected to change between runs and does not affect the logic or computed results.

## Why `run_id` is stable but output paths may differ

`run_id` is computed from:

- git SHA
- config hash
- data hash
- execution mode
- parameters used

If those are identical, `run_id` is identical. Output paths can still differ because the output root directory is an operator choice.

## Mac vs Linux differences (cosmetic only)

Minor differences can appear in:

- Platform metadata strings
- File timestamp metadata

These do **not** affect the data or computed metrics, which must remain identical for the same inputs.

## How to reproduce a run exactly

To reproduce a run with the exact same results:

1. **Use the same git SHA**
2. **Use the same config** (verified by config hash)
3. **Use the same data** (same file path and data hash)
4. **Use the same command and parameters**

If any of the above differ, the run is not equivalent and should be treated as a different experiment.

---

If a result is missing provenance fields, mismatches parity, or violates guardrails, it is invalid and the system should have already failed.
